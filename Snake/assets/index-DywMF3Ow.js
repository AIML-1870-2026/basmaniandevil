(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var v=(o=>(o.Up="up",o.Down="down",o.Left="left",o.Right="right",o))(v||{}),w=(o=>(o.Start="start",o.Playing="playing",o.Paused="paused",o.GameOver="gameover",o.LevelTransition="levelTransition",o.Settings="settings",o))(w||{}),m=(o=>(o.Normal="normal",o.Bonus="bonus",o.Golden="golden",o))(m||{}),S=(o=>(o.Ghost="ghost",o.SlowDown="slowdown",o.DoublePoints="double",o.Magnet="magnet",o.Shield="shield",o))(S||{}),L=(o=>(o.Wrap="wrap",o.Wall="wall",o))(L||{}),P=(o=>(o.Easy="easy",o.Normal="normal",o.Hard="hard",o))(P||{});const l={cyan:"#00FFFF",magenta:"#FF00FF",green:"#00FF41",pink:"#FF0080",orange:"#FF6600",yellow:"#FFE600",purple:"#9D00FF",red:"#FF0040",blue:"#0080FF",white:"#FFFFFF",background:"#0a0a0f"},et={[m.Normal]:l.pink,[m.Bonus]:l.orange,[m.Golden]:l.yellow},st={[m.Normal]:10,[m.Bonus]:25,[m.Golden]:50},j={[S.Ghost]:l.purple,[S.SlowDown]:l.green,[S.DoublePoints]:l.yellow,[S.Magnet]:l.magenta,[S.Shield]:l.cyan},it={[S.Ghost]:5e3,[S.SlowDown]:7e3,[S.DoublePoints]:1e4,[S.Magnet]:6e3,[S.Shield]:1/0},nt={[S.Ghost]:.08,[S.SlowDown]:.12,[S.DoublePoints]:.1,[S.Magnet]:.07,[S.Shield]:.05},ot={[P.Easy]:200,[P.Normal]:150,[P.Hard]:100},_=3e3,V=8,rt=1e4,ht=15e3,at=2e4,H=10,ct=3,Z=25,lt=20,Y=10,U=[{level:1,targetScore:100,tickMultiplier:1,obstacles:[],powerUpChance:.05,foodTypes:[m.Normal]},{level:2,targetScore:250,tickMultiplier:.9,obstacles:[],powerUpChance:.08,foodTypes:[m.Normal,m.Bonus]},{level:3,targetScore:500,tickMultiplier:.8,obstacles:[],powerUpChance:.1,foodTypes:[m.Normal,m.Bonus]},{level:4,targetScore:800,tickMultiplier:.75,obstacles:[{segments:[{x:5,y:5},{x:5,y:6},{x:5,y:7}]},{segments:[{x:14,y:12},{x:14,y:13},{x:14,y:14}]},{segments:[{x:9,y:9},{x:10,y:9},{x:11,y:9}]}],powerUpChance:.12,foodTypes:[m.Normal,m.Bonus]},{level:5,targetScore:1200,tickMultiplier:.7,obstacles:[{segments:[{x:3,y:3},{x:4,y:3},{x:5,y:3}]},{segments:[{x:14,y:3},{x:15,y:3},{x:16,y:3}]},{segments:[{x:3,y:16},{x:4,y:16},{x:5,y:16}]},{segments:[{x:14,y:16},{x:15,y:16},{x:16,y:16}]},{segments:[{x:9,y:9},{x:10,y:9},{x:9,y:10},{x:10,y:10}]}],powerUpChance:.14,foodTypes:[m.Normal,m.Bonus,m.Golden]},{level:6,targetScore:1700,tickMultiplier:.65,obstacles:[{segments:[{x:2,y:5},{x:2,y:6},{x:2,y:7},{x:2,y:8}]},{segments:[{x:17,y:11},{x:17,y:12},{x:17,y:13},{x:17,y:14}]},{segments:[{x:5,y:2},{x:6,y:2},{x:7,y:2},{x:8,y:2}]},{segments:[{x:11,y:17},{x:12,y:17},{x:13,y:17},{x:14,y:17}]},{segments:[{x:9,y:7},{x:10,y:7},{x:9,y:12},{x:10,y:12}]},{segments:[{x:7,y:9},{x:7,y:10},{x:12,y:9},{x:12,y:10}]},{segments:[{x:0,y:10},{x:1,y:10}]}],powerUpChance:.16,foodTypes:[m.Normal,m.Bonus,m.Golden]},{level:7,targetScore:2300,tickMultiplier:.6,obstacles:[{segments:[{x:4,y:4},{x:5,y:4},{x:6,y:4},{x:7,y:4},{x:8,y:4}]},{segments:[{x:11,y:15},{x:12,y:15},{x:13,y:15},{x:14,y:15},{x:15,y:15}]},{segments:[{x:4,y:8},{x:4,y:9},{x:4,y:10},{x:4,y:11}]},{segments:[{x:15,y:8},{x:15,y:9},{x:15,y:10},{x:15,y:11}]}],powerUpChance:.18,foodTypes:[m.Normal,m.Bonus,m.Golden]},{level:8,targetScore:3e3,tickMultiplier:.55,obstacles:[{segments:[{x:3,y:3},{x:4,y:3},{x:5,y:3},{x:5,y:4},{x:5,y:5}]},{segments:[{x:14,y:3},{x:15,y:3},{x:16,y:3},{x:14,y:4},{x:14,y:5}]},{segments:[{x:3,y:16},{x:4,y:16},{x:5,y:16},{x:5,y:15},{x:5,y:14}]},{segments:[{x:14,y:16},{x:15,y:16},{x:16,y:16},{x:14,y:15},{x:14,y:14}]},{segments:[{x:9,y:9},{x:10,y:9},{x:9,y:10},{x:10,y:10}]}],powerUpChance:.2,foodTypes:[m.Normal,m.Bonus,m.Golden]},{level:9,targetScore:4e3,tickMultiplier:.5,obstacles:[{segments:[{x:2,y:2},{x:3,y:2},{x:4,y:2},{x:5,y:2},{x:6,y:2}]},{segments:[{x:13,y:2},{x:14,y:2},{x:15,y:2},{x:16,y:2},{x:17,y:2}]},{segments:[{x:2,y:17},{x:3,y:17},{x:4,y:17},{x:5,y:17},{x:6,y:17}]},{segments:[{x:13,y:17},{x:14,y:17},{x:15,y:17},{x:16,y:17},{x:17,y:17}]},{segments:[{x:7,y:7},{x:8,y:7},{x:9,y:7},{x:10,y:7},{x:11,y:7},{x:12,y:7}]},{segments:[{x:7,y:12},{x:8,y:12},{x:9,y:12},{x:10,y:12},{x:11,y:12},{x:12,y:12}]}],powerUpChance:.22,foodTypes:[m.Normal,m.Bonus,m.Golden]},{level:10,targetScore:5e3,tickMultiplier:.45,obstacles:[{segments:[{x:1,y:5},{x:2,y:5},{x:3,y:5},{x:4,y:5}]},{segments:[{x:15,y:5},{x:16,y:5},{x:17,y:5},{x:18,y:5}]},{segments:[{x:1,y:14},{x:2,y:14},{x:3,y:14},{x:4,y:14}]},{segments:[{x:15,y:14},{x:16,y:14},{x:17,y:14},{x:18,y:14}]},{segments:[{x:5,y:1},{x:5,y:2},{x:5,y:3},{x:5,y:4}]},{segments:[{x:14,y:1},{x:14,y:2},{x:14,y:3},{x:14,y:4}]},{segments:[{x:5,y:15},{x:5,y:16},{x:5,y:17},{x:5,y:18}]},{segments:[{x:14,y:15},{x:14,y:16},{x:14,y:17},{x:14,y:18}]},{segments:[{x:8,y:8},{x:9,y:8},{x:10,y:8},{x:11,y:8},{x:8,y:11},{x:9,y:11},{x:10,y:11},{x:11,y:11},{x:8,y:9},{x:8,y:10},{x:11,y:9},{x:11,y:10}]}],powerUpChance:.25,foodTypes:[m.Normal,m.Bonus,m.Golden]}];class dt{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){const s=this.listeners.get(t);if(s){const i=s.indexOf(e);i!==-1&&s.splice(i,1)}}emit(t,e){const s=this.listeners.get(t);if(s)for(const i of s)i(e)}clear(){this.listeners.clear()}}class ut{constructor(){this.directionQueue=[],this.currentDirection=v.Right,this.keysDown=new Set,this.keyCallbacks=new Map,window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t))}onKeyDown(t){if(this.keysDown.has(t.key))return;this.keysDown.add(t.key);const e=this.keyToDirection(t.key);if(e!==null){t.preventDefault();const i=this.getLastQueuedDir();!this.isOpposite(e,i)&&this.directionQueue.length<2&&this.directionQueue.push(e)}const s=this.keyCallbacks.get(t.key);s&&s()}onKeyUp(t){this.keysDown.delete(t.key)}consumeDirection(){return this.directionQueue.length>0&&(this.currentDirection=this.directionQueue.shift()),this.currentDirection}getCurrentDirection(){return this.currentDirection}resetDirection(t){this.currentDirection=t,this.directionQueue.length=0}onKey(t,e){this.keyCallbacks.set(t,e)}clearCallbacks(){this.keyCallbacks.clear()}isKeyDown(t){return this.keysDown.has(t)}keyToDirection(t){switch(t){case"ArrowUp":case"w":case"W":return v.Up;case"ArrowDown":case"s":case"S":return v.Down;case"ArrowLeft":case"a":case"A":return v.Left;case"ArrowRight":case"d":case"D":return v.Right;default:return null}}isOpposite(t,e){return t===v.Up&&e===v.Down||t===v.Down&&e===v.Up||t===v.Left&&e===v.Right||t===v.Right&&e===v.Left}getLastQueuedDir(){return this.directionQueue.length>0?this.directionQueue[this.directionQueue.length-1]:this.currentDirection}}class pt{constructor(t,e,s){this.lastTime=0,this.accumulator=0,this.running=!1,this.rafId=0,this._tickRate=t,this.updateFn=e,this.renderFn=s}start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.accumulator=0,this.rafId=requestAnimationFrame(t=>this.loop(t)))}stop(){this.running=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=0)}get tickRate(){return this._tickRate}set tickRate(t){this._tickRate=t}loop(t){if(!this.running)return;const e=Math.min(t-this.lastTime,200);for(this.lastTime=t,this.accumulator+=e;this.accumulator>=this._tickRate;)this.updateFn(this._tickRate),this.accumulator-=this._tickRate;const s=this.accumulator/this._tickRate;this.renderFn(s),this.rafId=requestAnimationFrame(i=>this.loop(i))}}class ft{constructor(){this.screens=new Map,this._current=w.Start}register(t,e){this.screens.set(t,e)}get current(){return this._current}get currentHandler(){return this.screens.get(this._current)}transitionTo(t){const e=this._current,s=this.screens.get(e),i=this.screens.get(t);s&&s.exit(t),this._current=t,i&&i.enter(e)}update(t){this.currentHandler?.update(t)}render(t,e){this.currentHandler?.render(t,e)}handleInput(t,e){this.currentHandler?.handleInput(t,e)}}function X(o,t,e){return o+(t-o)*e}function W(o,t){return Math.floor(Math.random()*(t-o+1))+o}function gt(o,t){return Math.random()*(t-o)+o}function K(o,t){return(o%t+t)%t}class mt{constructor(){this.segments=[],this.direction=v.Right,this.growthPending=0,this.alive=!0}init(t){this.segments=[],this.direction=v.Right,this.growthPending=0,this.alive=!0;const e=Math.floor(t/2),s=Math.floor(t/2);for(let i=0;i<ct;i++)this.segments.push({x:e-i,y:s,prevX:e-i,prevY:s})}move(t,e,s){this.direction=t;for(const a of this.segments)a.prevX=a.x,a.prevY=a.y;const i=this.segments[0];let n=i.x,r=i.y;switch(this.direction){case v.Up:r--;break;case v.Down:r++;break;case v.Left:n--;break;case v.Right:n++;break}let c=!1;s===L.Wrap?(n=K(n,e),r=K(r,e)):(n<0||n>=e||r<0||r>=e)&&(c=!0);const h={x:n,y:r,prevX:i.x,prevY:i.y};return this.segments.unshift(h),this.growthPending>0?this.growthPending--:this.segments.pop(),{hitWall:c,newHead:{x:n,y:r}}}grow(t=1){this.growthPending+=t}checkSelfCollision(){const t=this.segments[0];for(let e=1;e<this.segments.length;e++)if(this.segments[e].x===t.x&&this.segments[e].y===t.y)return!0;return!1}getHead(){return this.segments[0]}occupies(t,e){return this.segments.some(s=>s.x===t&&s.y===e)}get length(){return this.segments.length}}class yt{constructor(){this.item=null}spawn(t,e,s,i=!1){const n=this.pickType(s),r=this.findFreeCell(t,e);r&&(this.item={x:r.x,y:r.y,type:n,points:st[n],pulsePhase:Math.random()*Math.PI*2},i&&(this.item.isRunner=!0,this.item.runnerDir=Math.random()<.5?-1:1,this.item.runnerOffset=0))}clear(){this.item=null}pickType(t){if(t.length===1)return t[0];const e=Math.random();return t.includes(m.Golden)&&e<.05?m.Golden:t.includes(m.Bonus)&&e<.2?m.Bonus:m.Normal}findFreeCell(t,e){const s=t*t;if(e.length>=s)return null;for(let i=0;i<100;i++){const n=W(0,t-1),r=W(0,t-1);if(!e.some(c=>c.x===n&&c.y===r))return{x:n,y:r}}for(let i=0;i<t;i++)for(let n=0;n<t;n++)if(!e.some(r=>r.x===i&&r.y===n))return{x:i,y:n};return null}}class St{constructor(){this.obstacles=[]}setObstacles(t,e){this.obstacles=t.map(s=>({segments:s.segments.filter(i=>i.x>=0&&i.x<e&&i.y>=0&&i.y<e)}))}clear(){this.obstacles=[]}getAllCells(){const t=[];for(const e of this.obstacles)for(const s of e.segments)t.push({x:s.x,y:s.y});return t}isObstacle(t,e){for(const s of this.obstacles)for(const i of s.segments)if(i.x===t&&i.y===e)return!0;return!1}get data(){return this.obstacles}}class xt{check(t,e,s,i,n,r){const c=t.getHead(),h={ateFood:!1,hitSelf:!1,hitWall:!1,hitObstacle:!1,atePowerUp:!1};return e.item&&e.item.x===c.x&&e.item.y===c.y&&(h.ateFood=!0),i.item&&i.item.x===c.x&&i.item.y===c.y&&(h.atePowerUp=!0,h.powerUpType=i.item.type),r.has(S.Ghost)||(n&&(h.hitWall=!0),t.checkSelfCollision()&&(h.hitSelf=!0),s.isObstacle(c.x,c.y)&&(h.hitObstacle=!0),r.has(S.Shield)&&(h.hitSelf||h.hitWall||h.hitObstacle)&&(h.hitSelf=!1,h.hitWall=!1,h.hitObstacle=!1)),h}getOccupiedCells(t,e,s,i){const n=[];for(const r of t.segments)n.push({x:r.x,y:r.y});for(const r of e.getAllCells())n.push(r);return s.item&&n.push({x:s.item.x,y:s.item.y}),i.item&&n.push({x:i.item.x,y:i.item.y}),n}}class vt{constructor(t){this.eventBus=t,this.score=0,this.combo=0,this.comboTimer=0,this.foodEaten=0,this.totalFoodEaten=0}reset(){this.score=0,this.combo=0,this.comboTimer=0,this.foodEaten=0,this.totalFoodEaten=0}resetLevelFood(){this.foodEaten=0}onFoodEaten(t,e){this.combo++,this.combo>V&&(this.combo=V),this.comboTimer=_,this.foodEaten++,this.totalFoodEaten++;let s=1+(this.combo-1)*.5;e.has(S.DoublePoints)&&(s*=2);const i=Math.floor(t*s);return this.score+=i,this.eventBus.emit("score:updated",{score:this.score,combo:this.combo,pointsGained:i}),this.combo>1&&this.eventBus.emit("combo:increment",{combo:this.combo}),i}update(t){this.comboTimer>0&&(this.comboTimer-=t,this.comboTimer<=0&&(this.comboTimer=0,this.combo>0&&(this.combo=0,this.eventBus.emit("combo:reset"))))}get comboProgress(){return this.comboTimer/_}}class wt{constructor(t){this.currentLevel=1,this.eventBus=t}reset(){this.currentLevel=1}getLevelConfig(){const t=Math.min(this.currentLevel-1,U.length-1);return U[t]}getTickRate(t){const e=ot[t],s=this.getLevelConfig();return Math.max(50,Math.floor(e*s.tickMultiplier))}checkLevelUp(t){return t>=Y&&this.currentLevel<U.length}levelUp(){this.currentLevel++;const t=this.getLevelConfig();return this.eventBus.emit("level:complete",{level:this.currentLevel,config:t}),t}get maxLevel(){return U.length}}class bt{constructor(){this.item=null}spawn(t,e){const s=this.pickType(),i=this.findFreeCell(t,e);i&&(this.item={x:i.x,y:i.y,type:s,spawnTime:performance.now(),timeoutDuration:rt})}clear(){this.item=null}isExpired(){return this.item?performance.now()-this.item.spawnTime>this.item.timeoutDuration:!1}pickType(){const t=Object.values(S),e=t.map(n=>nt[n]),s=e.reduce((n,r)=>n+r,0);let i=Math.random()*s;for(let n=0;n<t.length;n++)if(i-=e[n],i<=0)return t[n];return t[t.length-1]}findFreeCell(t,e){for(let s=0;s<100;s++){const i=W(0,t-1),n=W(0,t-1);if(!e.some(r=>r.x===i&&r.y===n))return{x:i,y:n}}return null}}class Mt{constructor(t){this.activeEffects=new Map,this.spawnTimer=0,this.entity=new bt,this.eventBus=t,this.nextSpawnTime=this.randomSpawnInterval()}reset(){this.activeEffects.clear(),this.entity.clear(),this.spawnTimer=0,this.nextSpawnTime=this.randomSpawnInterval()}update(t,e,s,i){this.entity.item||(this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnTime&&Math.random()<i&&(this.entity.spawn(e,s),this.spawnTimer=0,this.nextSpawnTime=this.randomSpawnInterval())),this.entity.isExpired()&&this.entity.clear();const n=performance.now();for(const[r,c]of this.activeEffects.entries())n>=c.expiresAt&&(this.activeEffects.delete(r),this.eventBus.emit("powerup:expired",{type:r}))}activate(t){const e=it[t];e===1/0?this.activeEffects.set(t,{type:t,expiresAt:1/0}):this.activeEffects.set(t,{type:t,expiresAt:performance.now()+e}),this.entity.clear(),this.eventBus.emit("powerup:collected",{type:t})}consumeShield(){this.activeEffects.delete(S.Shield),this.eventBus.emit("powerup:expired",{type:S.Shield})}getActiveTypes(){return new Set(this.activeEffects.keys())}getActiveLabel(){const t=Array.from(this.activeEffects.keys());return t.length===0?null:t.map(e=>e.toUpperCase()).join(" + ")}isSlowed(){return this.activeEffects.has(S.SlowDown)}isMagnet(){return this.activeEffects.has(S.Magnet)}randomSpawnInterval(){return gt(ht,at)}}function Tt(o,t,e,s,i,n,r=15,c=3){o.save(),o.shadowColor=n,o.shadowBlur=r,o.fillStyle=n,tt(o,t,e,s,i,c),o.fill(),o.fill(),o.restore()}function zt(o,t,e,s,i,n=15){o.save(),o.shadowColor=i,o.shadowBlur=n,o.fillStyle=i,o.beginPath(),o.arc(t,e,s,0,Math.PI*2),o.fill(),o.fill(),o.restore()}function y(o,t,e,s,i,n,r=20,c="center",h="middle"){o.save(),o.font=`bold ${n}px "Courier New", monospace`,o.textAlign=c,o.textBaseline=h,o.shadowColor=i,o.shadowBlur=r,o.fillStyle=i,o.fillText(t,e,s),o.fillText(t,e,s),o.restore()}function Et(o,t,e,s,i,n,r=1,c=10,h=4){o.save(),o.shadowColor=n,o.shadowBlur=c,o.strokeStyle=n,o.lineWidth=r,tt(o,t,e,s,i,h),o.stroke(),o.stroke(),o.restore()}function tt(o,t,e,s,i,n){o.beginPath(),o.moveTo(t+n,e),o.lineTo(t+s-n,e),o.quadraticCurveTo(t+s,e,t+s,e+n),o.lineTo(t+s,e+i-n),o.quadraticCurveTo(t+s,e+i,t+s-n,e+i),o.lineTo(t+n,e+i),o.quadraticCurveTo(t,e+i,t,e+i-n),o.lineTo(t,e+n),o.quadraticCurveTo(t,e,t+n,e),o.closePath()}function $(o){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function Rt(o,t,e){return"#"+[o,t,e].map(s=>Math.round(s).toString(16).padStart(2,"0")).join("")}function E(o,t){const{r:e,g:s,b:i}=$(o);return`rgba(${e}, ${s}, ${i}, ${t})`}function I(o,t,e){const s=$(o),i=$(t);return Rt(s.r+(i.r-s.r)*e,s.g+(i.g-s.g)*e,s.b+(i.b-s.b)*e)}class Ot{render(t,e,s,i,n){const r=s*e,c=i*e;t.fillStyle=l.background,t.fillRect(0,0,r,c);const h=.25+Math.sin(n*.001)*.08;t.save(),t.shadowColor=l.cyan,t.shadowBlur=2,t.strokeStyle=E(l.cyan,h),t.lineWidth=.8,t.beginPath();for(let u=0;u<=s;u++)t.moveTo(u*e,0),t.lineTo(u*e,c);for(let u=0;u<=i;u++)t.moveTo(0,u*e),t.lineTo(r,u*e);t.stroke(),t.restore(),t.save(),t.shadowColor=l.cyan,t.shadowBlur=8,t.strokeStyle=E(l.cyan,.5),t.lineWidth=1.5,t.strokeRect(0,0,r,c),t.restore();const a=n*.05%c,d=t.createLinearGradient(0,a-30,0,a+30);d.addColorStop(0,"rgba(0, 255, 255, 0)"),d.addColorStop(.5,"rgba(0, 255, 255, 0.045)"),d.addColorStop(1,"rgba(0, 255, 255, 0)"),t.fillStyle=d,t.fillRect(0,a-30,r,60)}}class Q{constructor(t,e,s){this.ctx=t,this.gridSize=e,this.particles=s,this.gridRenderer=new Ot,this.cellSize=Z}get canvasSize(){return this.gridSize*this.cellSize}clear(){this.ctx.clearRect(0,0,this.canvasSize,this.canvasSize)}renderBackground(t){this.gridRenderer.render(this.ctx,this.cellSize,this.gridSize,this.gridSize,t)}renderSnake(t,e,s,i){const n=t.length,r=this.cellSize/2,c=s.has(S.Ghost),h=[];for(let a=0;a<n;a++){const d=t[a];h.push({cx:X(d.prevX,d.x,e)*this.cellSize+r,cy:X(d.prevY,d.y,e)*this.cellSize+r})}for(let a=n-1;a>=1;a--){const d=a/Math.max(1,n-1),u=(a-1)/Math.max(1,n-1),p=I(l.cyan,l.magenta,(d+u)/2),f=1-(d+u)/2*.5,g=this.cellSize*(.35+.35*(1-d));this.ctx.save(),this.ctx.globalAlpha=f*(c?.4:1),this.ctx.strokeStyle=p,this.ctx.shadowColor=p,this.ctx.shadowBlur=10*f,this.ctx.lineWidth=g,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(h[a-1].cx,h[a-1].cy),this.ctx.lineTo(h[a].cx,h[a].cy),this.ctx.stroke(),this.ctx.restore()}for(let a=n-1;a>=1;a--){const d=a/Math.max(1,n-1),u=I(l.cyan,l.magenta,d),p=1-d*.5,f=this.cellSize*(.32+.18*(1-d));this.ctx.save(),this.ctx.globalAlpha=p*(c?.4:1),this.ctx.shadowColor=u,this.ctx.shadowBlur=10*p,this.ctx.fillStyle=u,this.ctx.beginPath(),this.ctx.arc(h[a].cx,h[a].cy,f,0,Math.PI*2),this.ctx.fill();const g=I(u,"#FFFFFF",.4);this.ctx.globalAlpha=.25*p*(c?.4:1),this.ctx.fillStyle=g,this.ctx.beginPath(),this.ctx.arc(h[a].cx-f*.25,h[a].cy-f*.25,f*.4,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}for(let a=1;a<n;a+=2){const d=a/Math.max(1,n-1),u=1-d*.5,p=this.cellSize*(.12+.08*(1-d));this.ctx.save(),this.ctx.globalAlpha=.15*u*(c?.4:1),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.arc(h[a].cx,h[a].cy,p,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}if(n>0){const a=c?l.purple:(s.has(S.Shield),l.cyan),d=this.cellSize*.5,u=h[0].cx,p=h[0].cy;s.has(S.Shield)&&(this.ctx.save(),this.ctx.globalAlpha=.2,zt(this.ctx,u,p,d+6,l.cyan,25),this.ctx.restore()),this.ctx.save(),this.ctx.globalAlpha=c?.5:1,this.ctx.shadowColor=a,this.ctx.shadowBlur=22,this.ctx.fillStyle=a,this.ctx.beginPath(),this.ctx.arc(u,p,d,0,Math.PI*2),this.ctx.fill(),this.ctx.fill();const f=I(a,"#FFFFFF",.5);this.ctx.globalAlpha=.35*(c?.5:1),this.ctx.shadowBlur=0,this.ctx.fillStyle=f,this.ctx.beginPath(),this.ctx.arc(u-d*.2,p-d*.2,d*.45,0,Math.PI*2),this.ctx.fill(),this.ctx.restore();let g=0;switch(i){case v.Right:g=0;break;case v.Left:g=Math.PI;break;case v.Up:g=-Math.PI/2;break;case v.Down:g=Math.PI/2;break}const b=d*.4,M=Math.PI*.35,x=d*.2,T=x*.55;for(const z of[-1,1]){const F=g+z*M,C=u+Math.cos(F)*b,O=p+Math.sin(F)*b;this.ctx.save(),this.ctx.globalAlpha=c?.5:.95,this.ctx.shadowColor="#FFFFFF",this.ctx.shadowBlur=4,this.ctx.fillStyle="#EEFFEE",this.ctx.beginPath(),this.ctx.arc(C,O,x,0,Math.PI*2),this.ctx.fill();const A=Math.cos(g)*x*.25,k=Math.sin(g)*x*.25;this.ctx.fillStyle="#0a0a0f",this.ctx.shadowBlur=0,this.ctx.beginPath(),this.ctx.arc(C+A,O+k,T,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(C+A-T*.3,O+k-T*.3,T*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}if(Math.sin(performance.now()*.008)>.6){const z=d*.7,F=u+Math.cos(g)*d*.85,C=p+Math.sin(g)*d*.85,O=F+Math.cos(g)*z,A=C+Math.sin(g)*z,k=z*.35,D=.4;this.ctx.save(),this.ctx.globalAlpha=c?.4:.9,this.ctx.strokeStyle=l.red,this.ctx.shadowColor=l.red,this.ctx.shadowBlur=5,this.ctx.lineWidth=1.5,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(F,C),this.ctx.lineTo(O,A),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(O,A),this.ctx.lineTo(O+Math.cos(g+D)*k,A+Math.sin(g+D)*k),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(O,A),this.ctx.lineTo(O+Math.cos(g-D)*k,A+Math.sin(g-D)*k),this.ctx.stroke(),this.ctx.restore()}}if(n>=2){const a=h[n-1],d=h[n-2],u=Math.atan2(a.cy-d.cy,a.cx-d.cx),p=a.cx+Math.cos(u)*this.cellSize*.3,f=a.cy+Math.sin(u)*this.cellSize*.3,g=I(l.cyan,l.magenta,1);this.ctx.save(),this.ctx.globalAlpha=.4*(c?.4:1),this.ctx.shadowColor=g,this.ctx.shadowBlur=6,this.ctx.fillStyle=g,this.ctx.beginPath(),this.ctx.arc(p,f,this.cellSize*.12,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}}renderFood(t,e){const s=this.cellSize,i=t.x*s+s/2,n=t.y*s+s/2,r=i+(t.runnerOffset??0);this.ctx.save(),this.ctx.shadowColor="#FFFFFF",this.ctx.shadowBlur=14,this.ctx.strokeStyle="#FFFFFF",this.ctx.fillStyle="#FFFFFF",this.ctx.lineCap="round",this.ctx.lineJoin="round";const c=s*.035,h=c*2.2;if(t.isRunner){const a=t.runnerDir??1,d=e*.012,u=Math.sin(d),p=a*s*.03,f=n-s*.2,g=n+s*.15,b=f-h-c*.5;this.ctx.lineWidth=c*1.6,this.ctx.beginPath(),this.ctx.arc(r+p*.5,b,h,0,Math.PI*2),this.ctx.stroke(),this.ctx.lineWidth=c*1.8,this.ctx.beginPath(),this.ctx.moveTo(r+p*.3,f),this.ctx.lineTo(r,g),this.ctx.stroke();const M=f+(g-f)*.2,x=s*.16,T=u*.8;this.ctx.lineWidth=c*1.6,this.ctx.beginPath(),this.ctx.moveTo(r+p*.2,M),this.ctx.lineTo(r+p*.2+Math.sin(T)*x,M+Math.cos(T)*x),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(r+p*.2,M),this.ctx.lineTo(r+p*.2+Math.sin(-T)*x,M+Math.cos(-T)*x),this.ctx.stroke();const R=s*.2,z=-u*.7;this.ctx.lineWidth=c*1.6,this.ctx.beginPath(),this.ctx.moveTo(r,g),this.ctx.lineTo(r+Math.sin(z)*R,g+Math.cos(z)*R),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(r,g),this.ctx.lineTo(r+Math.sin(-z)*R,g+Math.cos(-z)*R),this.ctx.stroke()}else{const a=Math.sin(e*.005+t.pulsePhase)*s*.02,d=n-s*.2+a,u=n+s*.15+a,p=d-h-c*.5;this.ctx.lineWidth=c*1.6,this.ctx.beginPath(),this.ctx.arc(r,p,h,0,Math.PI*2),this.ctx.stroke(),this.ctx.lineWidth=c*1.8,this.ctx.beginPath(),this.ctx.moveTo(r,d),this.ctx.lineTo(r,u),this.ctx.stroke();const f=d+(u-d)*.25,g=s*.18,b=s*.06;this.ctx.lineWidth=c*1.6,this.ctx.beginPath(),this.ctx.moveTo(r-g,f+b),this.ctx.lineTo(r,f),this.ctx.lineTo(r+g,f+b),this.ctx.stroke();const M=s*.15,x=s*.18;this.ctx.lineWidth=c*1.6,this.ctx.beginPath(),this.ctx.moveTo(r-M,u+x),this.ctx.lineTo(r,u),this.ctx.lineTo(r+M,u+x),this.ctx.stroke()}this.ctx.restore()}renderPowerUp(t,e){const s=j[t.type],i=t.x*this.cellSize+this.cellSize/2,n=t.y*this.cellSize+this.cellSize/2,r=performance.now()-t.spawnTime,c=t.timeoutDuration-r,h=c<3e3?c/3e3:1,a=c<2e3?Math.sin(e*.02)>0?1:.3:1;this.ctx.save(),this.ctx.globalAlpha=h*a;const d=this.cellSize*.4;this.ctx.shadowColor=s,this.ctx.shadowBlur=18,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.moveTo(i,n-d),this.ctx.lineTo(i+d,n),this.ctx.lineTo(i,n+d),this.ctx.lineTo(i-d,n),this.ctx.closePath(),this.ctx.fill(),this.ctx.fill();const u={[S.Ghost]:"G",[S.SlowDown]:"S",[S.DoublePoints]:"2x",[S.Magnet]:"M",[S.Shield]:"SH"};this.ctx.fillStyle="#000",this.ctx.font=`bold ${this.cellSize*.3}px "Courier New", monospace`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowBlur=0,this.ctx.fillText(u[t.type],i,n),this.ctx.restore()}renderObstacles(t,e){const s=.7+Math.sin(e*.003)*.3;for(const i of t)for(const n of i.segments){const r=n.x*this.cellSize,c=n.y*this.cellSize;Tt(this.ctx,r+1,c+1,this.cellSize-2,this.cellSize-2,l.red,10*s,2)}}renderParticles(){this.particles.render(this.ctx)}}class Pt{constructor(t,e,s=0){this.pool=[],this.factory=t,this.resetFn=e;for(let i=0;i<s;i++)this.pool.push(t())}acquire(){return this.pool.length>0?this.pool.pop():this.factory()}release(t){this.resetFn(t),this.pool.push(t)}get size(){return this.pool.length}}function Ct(){return{x:0,y:0,vx:0,vy:0,life:0,maxLife:0,color:"",size:0}}function Ft(o){o.x=0,o.y=0,o.vx=0,o.vy=0,o.life=0,o.maxLife=0,o.color="",o.size=0}class At{constructor(){this.particles=[],this.pool=new Pt(Ct,Ft,200)}burst(t,e,s,i,n=150){for(let r=0;r<i;r++){const c=this.pool.acquire(),h=Math.random()*Math.PI*2,a=30+Math.random()*n;c.x=t,c.y=e,c.vx=Math.cos(h)*a,c.vy=Math.sin(h)*a,c.life=.4+Math.random()*.6,c.maxLife=c.life,c.color=s,c.size=1.5+Math.random()*3,this.particles.push(c)}}update(t){const e=t/1e3;for(let s=this.particles.length-1;s>=0;s--){const i=this.particles[s];i.x+=i.vx*e,i.y+=i.vy*e,i.vx*=.96,i.vy*=.96,i.life-=e,i.life<=0&&(this.pool.release(i),this.particles.splice(s,1))}}render(t){for(const e of this.particles){const s=Math.max(0,e.life/e.maxLife),i=e.size*s;t.save(),t.globalAlpha=s,t.shadowColor=e.color,t.shadowBlur=8,t.fillStyle=e.color,t.beginPath(),t.arc(e.x,e.y,i,0,Math.PI*2),t.fill(),t.restore()}}clear(){for(const t of this.particles)this.pool.release(t);this.particles.length=0}get count(){return this.particles.length}}const q="neon-serpent-highscores";class kt{constructor(){this.scores=[],this.load()}getScores(){return[...this.scores]}isHighScore(t){return this.scores.length<H?t>0:t>this.scores[this.scores.length-1].score}addScore(t,e,s){const i={name:t,score:e,level:s,date:new Date().toISOString().split("T")[0]};this.scores.push(i),this.scores.sort((n,r)=>r.score-n.score),this.scores.length>H&&(this.scores=this.scores.slice(0,H)),this.save()}load(){try{const t=localStorage.getItem(q);t&&(this.scores=JSON.parse(t))}catch{this.scores=[]}}save(){try{localStorage.setItem(q,JSON.stringify(this.scores))}catch{}}}const J="neon-serpent-settings",N={difficulty:P.Normal,gridSize:lt,boundaryMode:L.Wrap};class Lt{constructor(){this.settings=this.load()}get(){return{...this.settings}}save(t){this.settings={...t};try{localStorage.setItem(J,JSON.stringify(this.settings))}catch{}}load(){try{const t=localStorage.getItem(J);if(t){const e=JSON.parse(t);return{difficulty:e.difficulty??N.difficulty,gridSize:e.gridSize??N.gridSize,boundaryMode:e.boundaryMode??N.boundaryMode}}}catch{}return{...N}}}class It{constructor(t,e,s,i){this.time=0,this.highScores=[],this.canvasSize=t,this.highScores=e,this.onStart=s,this.onSettings=i}updateHighScores(t){this.highScores=t}enter(){this.time=0}exit(){}update(t){this.time+=t}render(t){const e=this.canvasSize/2,s=Math.max(24,this.canvasSize*.07),i=25+Math.sin(this.time*.003)*10;y(t,"NEON",e,this.canvasSize*.18,l.cyan,s,i),y(t,"SERPENT",e,this.canvasSize*.18+s*1.2,l.magenta,s,i);const n=Math.max(10,this.canvasSize*.025);if(y(t,"A CYBERPUNK SNAKE GAME",e,this.canvasSize*.35,l.blue,n,8),Math.sin(this.time*.005)>0){const a=Math.max(12,this.canvasSize*.03);y(t,"PRESS ENTER TO START",e,this.canvasSize*.5,l.green,a,15)}const c=Math.max(9,this.canvasSize*.02);if(y(t,"PRESS [S] FOR SETTINGS",e,this.canvasSize*.57,E(l.white,.5),c,5),this.highScores.length>0){const a=this.canvasSize*.65,d=Math.max(14,this.canvasSize*.035),u=Math.max(11,this.canvasSize*.025);y(t,"- HIGH SCORES -",e,a,l.yellow,u,10);const p=this.highScores.slice(0,5);for(let f=0;f<p.length;f++){const g=p[f],b=a+d*(f+1.5),M=Math.min(1,(this.time-f*100)/500);if(M<=0)continue;t.save(),t.globalAlpha=M;const x=Math.max(9,this.canvasSize*.02),T=`${f+1}. ${g.name.padEnd(6)} ${String(g.score).padStart(6)} LVL${g.level}`;y(t,T,e,b,l.white,x,5),t.restore()}}const h=Math.max(8,this.canvasSize*.016);y(t,"ARROW KEYS / WASD TO MOVE | SPACE TO PAUSE",e,this.canvasSize*.95,E(l.cyan,.4),h,3)}handleInput(t){t==="Enter"||t===" "?this.onStart():(t==="s"||t==="S")&&this.onSettings()}}class G{drawHUD(t,e,s,i,n,r,c,h,a,d){const p=Math.max(12,e*.028);y(t,`SCORE: ${s}`,e-10,10+p/2,l.cyan,p,15,"right","middle"),y(t,`LVL ${i}`,10,10+p/2,l.magenta,p,15,"left","middle");const f=10+p+6,g=e*.15,b=4,M=a/d;if(t.fillStyle=E(l.magenta,.3),t.fillRect(10,f,g,b),t.fillStyle=l.magenta,t.shadowColor=l.magenta,t.shadowBlur=6,t.fillRect(10,f,g*Math.min(1,M),b),t.shadowBlur=0,n>1){const x=e-10-p,T=n>=5?l.yellow:l.orange;if(y(t,`COMBO x${n}`,e/2,x,T,p*1.2,20),c>0){const R=e*.2,z=3,F=e/2-R/2,C=x+p*.8,O=r/c;t.fillStyle=E(T,.3),t.fillRect(F,C,R,z),t.fillStyle=T,t.shadowColor=T,t.shadowBlur=4,t.fillRect(F,C,R*O,z),t.shadowBlur=0}}h&&y(t,`[${h.toUpperCase()}]`,e/2,10+p/2,l.purple,p*.9,12)}drawButton(t,e,s,i,n,r,c,h,a=!1){const d=a?20:8;Et(t,s-n/2,i-r/2,n,r,c,a?2:1,d),y(t,e,s,i,c,h,d)}drawOverlay(t,e,s=.8){t.fillStyle=`rgba(0, 0, 0, ${s})`,t.fillRect(0,0,e,e)}}class Bt{constructor(t,e,s,i,n,r,c,h,a,d,u,p,f,g,b){this.time=0,this.pointsPopups=[],this.renderer=t,this.uiRenderer=new G,this.snake=e,this.food=s,this.obstacles=i,this.score=n,this.levels=r,this.powerUps=c,this.collision=h,this.input=a,this.eventBus=d,this.gridSize=u,this.onPause=f,this.onGameOver=g,this.onLevelUp=b}enter(){}exit(){}update(t){this.time+=t;const e=this.input.consumeDirection(),{hitWall:s}=this.snake.move(e,this.gridSize,L.Wall);if(this.powerUps.isMagnet()&&this.food.item){const h=this.snake.getHead(),a=this.food.item;a.x<h.x?a.x++:a.x>h.x&&a.x--,a.y<h.y?a.y++:a.y>h.y&&a.y--}if(this.food.item?.isRunner){const h=this.food.item,a=this.renderer.cellSize,d=a*8e-4;h.runnerOffset=(h.runnerOffset??0)+h.runnerDir*t*d,Math.abs(h.runnerOffset)>=a&&(h.x+=h.runnerDir,h.runnerOffset-=h.runnerDir*a,(h.x<=0||h.x>=this.gridSize-1)&&(h.x=Math.max(0,Math.min(this.gridSize-1,h.x)),h.runnerDir=h.runnerDir===1?-1:1,h.runnerOffset=0))}const i=this.powerUps.getActiveTypes(),n=this.collision.check(this.snake,this.food,this.obstacles,this.powerUps.entity,s,i);if((n.hitSelf||n.hitWall||n.hitObstacle)&&i.has(S.Shield)&&this.powerUps.consumeShield(),n.ateFood&&this.food.item){const h=this.score.onFoodEaten(this.food.item.points,i);this.snake.grow();const a=this.food.item.x*this.renderer.cellSize+this.renderer.cellSize/2,d=this.food.item.y*this.renderer.cellSize+this.renderer.cellSize/2;this.renderer.particles.burst(a,d,et[this.food.item.type],15),this.pointsPopups.push({x:a,y:d,text:`+${h}`,life:1,color:this.score.combo>1?l.yellow:l.green});const u=this.collision.getOccupiedCells(this.snake,this.obstacles,this.food,this.powerUps.entity),p=this.levels.getLevelConfig(),f=this.score.foodEaten===Y-1;if(this.food.spawn(this.gridSize,u,p.foodTypes,f),this.levels.checkLevelUp(this.score.foodEaten)){this.onLevelUp();return}this.eventBus.emit("food:eaten")}if(n.atePowerUp&&n.powerUpType){this.powerUps.activate(n.powerUpType);const h=this.powerUps.entity.item?this.powerUps.entity.item.x*this.renderer.cellSize+this.renderer.cellSize/2:0,a=this.powerUps.entity.item?this.powerUps.entity.item.y*this.renderer.cellSize+this.renderer.cellSize/2:0;this.renderer.particles.burst(h,a,j[n.powerUpType],20,200)}if(n.hitSelf||n.hitWall||n.hitObstacle){this.snake.alive=!1;const h=this.snake.getHead(),a=h.x*this.renderer.cellSize+this.renderer.cellSize/2,d=h.y*this.renderer.cellSize+this.renderer.cellSize/2;this.renderer.particles.burst(a,d,l.red,30,250),this.onGameOver();return}this.score.update(t);const r=this.collision.getOccupiedCells(this.snake,this.obstacles,this.food,this.powerUps.entity),c=this.levels.getLevelConfig();this.powerUps.update(t,this.gridSize,r,c.powerUpChance),this.renderer.particles.update(t);for(let h=this.pointsPopups.length-1;h>=0;h--)this.pointsPopups[h].life-=t/1e3,this.pointsPopups[h].y-=t*.03,this.pointsPopups[h].life<=0&&this.pointsPopups.splice(h,1)}render(t,e){const s=this.renderer.canvasSize,i=this.powerUps.getActiveTypes();this.renderer.renderBackground(this.time),this.renderer.renderObstacles(this.obstacles.data,this.time),this.food.item&&this.renderer.renderFood(this.food.item,this.time),this.powerUps.entity.item&&this.renderer.renderPowerUp(this.powerUps.entity.item,this.time),this.renderer.renderSnake(this.snake.segments,e,i,this.snake.direction),this.renderer.renderParticles();for(const n of this.pointsPopups)t.save(),t.globalAlpha=n.life,t.shadowColor=n.color,t.shadowBlur=10,t.fillStyle=n.color,t.font=`bold ${s*.03}px "Courier New", monospace`,t.textAlign="center",t.fillText(n.text,n.x,n.y),t.restore();this.uiRenderer.drawHUD(t,s,this.score.score,this.levels.currentLevel,this.score.combo,this.score.comboTimer,_,this.powerUps.getActiveLabel(),this.score.foodEaten,Y)}handleInput(t){(t===" "||t==="Escape")&&this.onPause()}}class Dt{constructor(t,e,s,i){this.time=0,this.selectedOption=0,this.canvasSize=t,this.uiRenderer=new G,this.onResume=e,this.onRestart=s,this.onMenu=i,this.score=0,this.level=1}setStats(t,e){this.score=t,this.level=e}enter(){this.time=0,this.selectedOption=0}exit(){}update(t){this.time+=t}render(t){this.uiRenderer.drawOverlay(t,this.canvasSize,.8);const e=this.canvasSize/2,s=Math.max(20,this.canvasSize*.06),i=20+Math.sin(this.time*.004)*8;y(t,"PAUSED",e,this.canvasSize*.3,l.cyan,s,i);const n=Math.max(10,this.canvasSize*.025);y(t,`SCORE: ${this.score}`,e,this.canvasSize*.42,l.white,n,8),y(t,`LEVEL: ${this.level}`,e,this.canvasSize*.48,l.white,n,8);const r=["RESUME","RESTART","MAIN MENU"],c=Math.max(11,this.canvasSize*.028),h=this.canvasSize*.35,a=this.canvasSize*.06,d=this.canvasSize*.58,u=a*1.6;for(let f=0;f<r.length;f++){const g=f===this.selectedOption?l.cyan:E(l.white,.6);this.uiRenderer.drawButton(t,r[f],e,d+f*u,h,a,g,c,f===this.selectedOption)}const p=Math.max(8,this.canvasSize*.016);y(t,"PRESS SPACE TO RESUME",e,this.canvasSize*.92,E(l.white,.4),p,3)}handleInput(t){t===" "||t==="Escape"?this.onResume():t==="ArrowUp"||t==="w"||t==="W"?this.selectedOption=(this.selectedOption-1+3)%3:t==="ArrowDown"||t==="s"||t==="S"?this.selectedOption=(this.selectedOption+1)%3:t==="Enter"&&(this.selectedOption===0?this.onResume():this.selectedOption===1?this.onRestart():this.selectedOption===2&&this.onMenu())}}class Ut{constructor(t,e,s,i){this.time=0,this.score=0,this.level=1,this.foodEaten=0,this.maxCombo=0,this.isHighScore=!1,this.selectedOption=0,this.scoreSubmitted=!1,this.displayScore=0,this.canvasSize=t,this.uiRenderer=new G,this.onRestart=e,this.onMenu=s,this.onSubmitScore=i}setStats(t,e,s,i,n){this.score=t,this.level=e,this.foodEaten=s,this.maxCombo=i,this.isHighScore=n}enter(){this.time=0,this.selectedOption=0,this.scoreSubmitted=!1,this.displayScore=0}exit(){}update(t){this.time+=t,this.displayScore<this.score&&(this.displayScore+=Math.max(1,Math.floor(this.score*t/1500)),this.displayScore>this.score&&(this.displayScore=this.score))}render(t){this.uiRenderer.drawOverlay(t,this.canvasSize,.85);const e=this.canvasSize/2,s=Math.max(22,this.canvasSize*.065),i=Math.sin(this.time*.01)>.95?(Math.random()-.5)*6:0;y(t,"GAME OVER",e+i,this.canvasSize*.2,l.red,s,25);const n=Math.max(16,this.canvasSize*.045);if(y(t,`${this.displayScore}`,e,this.canvasSize*.35,l.yellow,n,18),this.isHighScore&&!this.scoreSubmitted){const x=Math.max(10,this.canvasSize*.025);Math.sin(this.time*.006)>0&&y(t,"NEW HIGH SCORE!",e,this.canvasSize*.42,l.yellow,x,15),y(t,"PRESS [H] TO SAVE SCORE",e,this.canvasSize*.47,E(l.green,.7),x*.8,5)}const r=Math.max(9,this.canvasSize*.022),c=this.canvasSize*.54,h=r*2;y(t,`LEVEL REACHED: ${this.level}`,e,c,l.white,r,6),y(t,`FOOD CONSUMED: ${this.foodEaten}`,e,c+h,l.white,r,6),y(t,`MAX COMBO: x${this.maxCombo}`,e,c+h*2,l.white,r,6);const a=["RETRY","MAIN MENU"],d=Math.max(11,this.canvasSize*.028),u=this.canvasSize*.3,p=this.canvasSize*.055,f=this.canvasSize*.76,g=p*1.8;for(let x=0;x<a.length;x++){const T=x===this.selectedOption?l.cyan:E(l.white,.6);this.uiRenderer.drawButton(t,a[x],e,f+x*g,u,p,T,d,x===this.selectedOption)}const b=Math.max(8,this.canvasSize*.017);Math.sin(this.time*.004)>0&&y(t,"PRESS ENTER TO PLAY AGAIN",e,this.canvasSize*.93,E(l.green,.7),b,8)}handleInput(t){if(t==="ArrowUp"||t==="w"||t==="W")this.selectedOption=(this.selectedOption-1+2)%2;else if(t==="ArrowDown"||t==="s"||t==="S")this.selectedOption=(this.selectedOption+1)%2;else if(t==="Enter")this.selectedOption===0?this.onRestart():this.onMenu();else if(t==="r"||t==="R")this.onRestart();else if((t==="h"||t==="H")&&this.isHighScore&&!this.scoreSubmitted){const e=prompt("Enter your name (3 chars):")||"AAA";this.onSubmitScore(e.substring(0,6).toUpperCase()||"AAA"),this.scoreSubmitted=!0}}}class Nt{constructor(t,e,s){this.time=0,this.level=1,this.duration=3e3,this.canvasSize=t,this.renderer=e,this.onComplete=s}setLevel(t){this.level=t}enter(){this.time=0}exit(){}update(t){this.time+=t,this.renderer.particles.update(t),this.time>=this.duration&&this.onComplete()}render(t){const e=this.canvasSize/2,s=this.canvasSize/2,i=this.time/this.duration;if(this.renderer.renderBackground(this.time),i<.1){const r=1-i/.1;t.fillStyle=`rgba(255, 255, 255, ${r*.4})`,t.fillRect(0,0,this.canvasSize,this.canvasSize)}t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,this.canvasSize,this.canvasSize);const n=Math.max(28,this.canvasSize*.08);if(i<.5){const r=Math.min(1,i/.3),c=20+r*20;t.save(),t.translate(e,s*.7),t.scale(r,r),y(t,`LEVEL ${this.level}`,0,0,l.cyan,n,c),t.restore()}else y(t,`LEVEL ${this.level}`,e,s*.7,l.cyan,n,35);if(i>.3&&i<.8){const r=Math.max(10,this.canvasSize*.025);y(t,"SPEED INCREASED",e,s,l.magenta,r,12)}if(i>.5){const r=(i-.5)/.5;let c="";r<.33?c="3":r<.66?c="2":r<.9?c="1":c="GO!";const h=Math.max(20,this.canvasSize*.06),a=c==="GO!"?l.green:l.yellow;y(t,c,e,s*1.3,a,h,25)}this.renderer.renderParticles()}handleInput(){}}class Wt{constructor(t,e,s,i){this.time=0,this.selectedRow=0,this.canvasSize=t,this.settings={...e},this.uiRenderer=new G,this.onBack=s,this.onSave=i,this.options=[{label:"DIFFICULTY",values:["EASY","NORMAL","HARD"],current:[P.Easy,P.Normal,P.Hard].indexOf(e.difficulty)},{label:"BOUNDARY",values:["WRAP","WALL"],current:e.boundaryMode===L.Wrap?0:1},{label:"GRID SIZE",values:["15","20","25","30"],current:[15,20,25,30].indexOf(e.gridSize)}],this.options[2].current===-1&&(this.options[2].current=1)}enter(){this.time=0,this.selectedRow=0}exit(){}update(t){this.time+=t}render(t){const e=this.canvasSize/2;t.fillStyle=l.background,t.fillRect(0,0,this.canvasSize,this.canvasSize);const s=Math.max(18,this.canvasSize*.05);y(t,"SETTINGS",e,this.canvasSize*.15,l.magenta,s,20);const i=Math.max(11,this.canvasSize*.028),n=this.canvasSize*.1,r=this.canvasSize*.32,c=e-this.canvasSize*.2,h=e+this.canvasSize*.15;for(let f=0;f<this.options.length;f++){const g=this.options[f],b=r+f*n,M=f===this.selectedRow,x=M?l.cyan:E(l.white,.6);y(t,g.label,c,b,x,i,M?12:5,"left");const T=M?l.yellow:E(l.white,.7),R=M?l.cyan:E(l.white,.3),z=i*.8;y(t,"<",h-this.canvasSize*.1,b,R,z,5),y(t,g.values[g.current],h,b,T,i,M?12:5),y(t,">",h+this.canvasSize*.1,b,R,z,5)}const a=this.canvasSize*.75,d=this.selectedRow===this.options.length,u=d?l.green:E(l.white,.6);this.uiRenderer.drawButton(t,"SAVE & BACK",e,a,this.canvasSize*.35,this.canvasSize*.06,u,i,d);const p=Math.max(8,this.canvasSize*.016);y(t,"ARROWS TO NAVIGATE | ENTER TO CONFIRM",e,this.canvasSize*.92,E(l.white,.3),p,3)}handleInput(t){const e=this.options.length+1;if(t==="ArrowUp"||t==="w"||t==="W")this.selectedRow=(this.selectedRow-1+e)%e;else if(t==="ArrowDown"||t==="s"||t==="S")this.selectedRow=(this.selectedRow+1)%e;else if(t==="ArrowLeft"||t==="a"||t==="A"){if(this.selectedRow<this.options.length){const s=this.options[this.selectedRow];s.current=(s.current-1+s.values.length)%s.values.length}}else if(t==="ArrowRight"||t==="d"||t==="D"){if(this.selectedRow<this.options.length){const s=this.options[this.selectedRow];s.current=(s.current+1)%s.values.length}}else t==="Enter"?this.applyAndBack():t==="Escape"&&this.onBack()}applyAndBack(){const t=[P.Easy,P.Normal,P.Hard],e=[L.Wrap,L.Wall],s=[15,20,25,30];this.settings.difficulty=t[this.options[0].current],this.settings.boundaryMode=e[this.options[1].current],this.settings.gridSize=s[this.options[2].current],this.onSave(this.settings),this.onBack()}}class Gt{constructor(t){this.maxCombo=0,this.gameTime=0,this.canvas=t,this.ctx=t.getContext("2d"),this.settingsManager=new Lt,this.settings=this.settingsManager.get(),this.highScores=new kt,this.eventBus=new dt,this.input=new ut,this.snake=new mt,this.food=new yt,this.obstacles=new St,this.collision=new xt,this.scoring=new vt(this.eventBus),this.levels=new wt(this.eventBus),this.powerUps=new Mt(this.eventBus),this.particles=new At,this.renderer=new Q(this.ctx,this.settings.gridSize,this.particles),this.stateMachine=new ft,this.resizeCanvas(),this.loop=new pt(this.levels.getTickRate(this.settings.difficulty),e=>this.update(e),e=>this.render(e)),this.setupScreens(),this.setupInput(),this.setupEvents(),this.stateMachine.transitionTo(w.Start)}start(){this.loop.start()}resizeCanvas(){const t=this.settings.gridSize*Z;this.canvas.width=t,this.canvas.height=t;const e=window.innerWidth,s=window.innerHeight,i=Math.min(e/t,s/t)*.95;this.canvas.style.width=`${t*i}px`,this.canvas.style.height=`${t*i}px`}setupScreens(){const t=this.renderer.canvasSize;this.startScreen=new It(t,this.highScores.getScores(),()=>this.startGame(),()=>this.stateMachine.transitionTo(w.Settings)),this.playingScreen=new Bt(this.renderer,this.snake,this.food,this.obstacles,this.scoring,this.levels,this.powerUps,this.collision,this.input,this.eventBus,this.settings.gridSize,this.settings.boundaryMode,()=>this.stateMachine.transitionTo(w.Paused),()=>this.gameOver(),()=>this.levelUp()),this.pausedScreen=new Dt(t,()=>this.stateMachine.transitionTo(w.Playing),()=>this.restartGame(),()=>this.backToMenu()),this.gameOverScreen=new Ut(t,()=>this.restartGame(),()=>this.backToMenu(),e=>{this.highScores.addScore(e,this.scoring.score,this.levels.currentLevel),this.startScreen.updateHighScores(this.highScores.getScores())}),this.levelTransScreen=new Nt(t,this.renderer,()=>this.completeLevelTransition()),this.settingsScreen=new Wt(t,this.settings,()=>this.stateMachine.transitionTo(w.Start),e=>this.applySettings(e)),this.stateMachine.register(w.Start,this.startScreen),this.stateMachine.register(w.Playing,this.playingScreen),this.stateMachine.register(w.Paused,this.pausedScreen),this.stateMachine.register(w.GameOver,this.gameOverScreen),this.stateMachine.register(w.LevelTransition,this.levelTransScreen),this.stateMachine.register(w.Settings,this.settingsScreen)}setupInput(){window.addEventListener("keydown",t=>{this.stateMachine.handleInput(t.key,!0)}),window.addEventListener("blur",()=>{this.stateMachine.current===w.Playing&&this.stateMachine.transitionTo(w.Paused)})}setupEvents(){this.eventBus.on("combo:increment",t=>{const{combo:e}=t;e>this.maxCombo&&(this.maxCombo=e)})}startGame(){this.resetGameState(),this.stateMachine.transitionTo(w.Playing)}restartGame(){this.resetGameState(),this.stateMachine.transitionTo(w.Playing)}backToMenu(){this.startScreen.updateHighScores(this.highScores.getScores()),this.stateMachine.transitionTo(w.Start)}resetGameState(){this.snake.init(this.settings.gridSize),this.input.resetDirection(v.Right),this.scoring.reset(),this.levels.reset(),this.powerUps.reset(),this.particles.clear(),this.maxCombo=0,this.gameTime=0;const t=this.levels.getLevelConfig();this.obstacles.setObstacles(t.obstacles,this.settings.gridSize);const e=this.collision.getOccupiedCells(this.snake,this.obstacles,this.food,this.powerUps.entity);this.food.spawn(this.settings.gridSize,e,t.foodTypes),this.loop.tickRate=this.levels.getTickRate(this.settings.difficulty)}gameOver(){const t=this.highScores.isHighScore(this.scoring.score);this.gameOverScreen.setStats(this.scoring.score,this.levels.currentLevel,this.scoring.totalFoodEaten,this.maxCombo,t),this.stateMachine.transitionTo(w.GameOver)}levelUp(){this.levels.levelUp(),this.levelTransScreen.setLevel(this.levels.currentLevel),this.stateMachine.transitionTo(w.LevelTransition)}completeLevelTransition(){const t=this.levels.getLevelConfig();this.obstacles.setObstacles(t.obstacles,this.settings.gridSize),this.scoring.resetLevelFood(),this.loop.tickRate=this.levels.getTickRate(this.settings.difficulty);const e=this.collision.getOccupiedCells(this.snake,this.obstacles,this.food,this.powerUps.entity);this.food.spawn(this.settings.gridSize,e,t.foodTypes),this.stateMachine.transitionTo(w.Playing)}applySettings(t){const e=t.gridSize!==this.settings.gridSize;this.settings={...t},this.settingsManager.save(this.settings),e&&(this.renderer=new Q(this.ctx,this.settings.gridSize,this.particles),this.resizeCanvas(),this.rebuildScreens())}rebuildScreens(){this.setupScreens(),this.stateMachine.transitionTo(w.Start)}update(t){if(this.stateMachine.current===w.Playing&&(this.gameTime+=t),this.stateMachine.current===w.Playing){let e=this.levels.getTickRate(this.settings.difficulty);this.powerUps.isSlowed()&&(e=Math.floor(e*1.5)),this.loop.tickRate=e}this.stateMachine.update(t)}render(t){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.stateMachine.render(this.ctx,t)}}const B=document.getElementById("gameCanvas");if(!B)throw new Error("Canvas element not found");const Ht=new Gt(B);Ht.start();window.addEventListener("resize",()=>{const o=B.width,t=window.innerWidth,e=window.innerHeight,s=Math.min(t/o,e/o)*.95;B.style.width=`${o*s}px`,B.style.height=`${o*s}px`});
